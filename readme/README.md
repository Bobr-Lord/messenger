
# Проект: Мессенджер на микросервисной архитектуре

## Краткое описание

Данный проект — это система обмена сообщениями в реальном времени, реализованная на языке Go с использованием микросервисной архитектуры. Система обрабатывает регистрацию пользователей, создание чатов, доставку сообщений через WebSocket, очереди Kafka, Redis для хранения подключений и PostgreSQL в качестве основного хранилища.

## Основные сервисы

- **Gateway** — основная точка входа. Обрабатывает WebSocket соединения, взаимодействует с Kafka и Redis, занимается доставкой сообщений.
- **Auth** — сервис аутентификации пользователей. Работает с JWT токенами.
- **Chat** — управление чатами и их участниками.
- **User** — управление учетными записями пользователей.
- **Message** — сохранение сообщений, работа с Kafka, формирование рассылки.

---

## Архитектура взаимодействия сервисов

```mermaid
graph TD
    Клиент --> |WebSocket| Gateway
    Gateway --> |Kafka: message.send| Message
    Message --> |Сохраняет в БД| PostgreSQL
    Message --> |Kafka: message.delivered| Gateway
    Gateway --> |WebSocket| Получатели
    Gateway --> Redis[Redis: хранение подключений WebSocket]
    Gateway --> |HTTP-запросы| Auth & Chat & User
```

---

## Принцип работы

1. Клиент подключается к WebSocket на Gateway.
2. Пользователь отправляет сообщение через WebSocket.
3. Gateway публикует сообщение в Kafka топик `message.send`.
4. Сервис Message обрабатывает сообщение:
    - Сохраняет его в PostgreSQL.
    - Формирует отдельные события доставки для каждого получателя и публикует их в Kafka топик `message.delivered`.
5. Gateway читает события из Kafka `message.delivered` и отправляет сообщения получателям через WebSocket.

---

## Топики Kafka

- **message.send** — пишет Gateway, читает Message.
- **message.delivered** — пишет Message, читает Gateway.

---

## Технологический стек

- **Go (Golang)** — язык реализации всех сервисов.
- **Kafka** — очередь сообщений для асинхронной доставки.
- **Redis** — хранение активных WebSocket-сессий пользователей.
- **PostgreSQL** — основная база данных.
- **Docker Compose** — сборка и запуск всей системы.
- **Swagger** — документация API (описания REST-запросов всех сервисов).

---

## Структура репозитория

- `gateway/` — центральный сервис, WebSocket сервер, Kafka брокер, Redis клиент.
- `auth/` — аутентификация, работа с JWT токенами.
- `chat/` — управление чатами и их участниками.
- `user/` — управление пользователями.
- `message/` — хранение и обработка сообщений.

---

## Переменные окружения

Все сервисы используют свои `.env` файлы. Примеры общих переменных:

```env
DATABASE_URL=postgres://user:password@postgres:5432/dbname?sslmode=disable
KAFKA_BROKERS=kafka:9092
REDIS_URL=redis:6379
JWT_SECRET=your_jwt_secret
```

---

## Запуск проекта

### Запуск через Docker Compose

```bash
cd gateway
docker-compose up --build
```

Docker Compose поднимет все сервисы и зависимости: Kafka, Redis, PostgreSQL.

### Запуск отдельных сервисов локально

У каждого сервиса есть точка входа: `cmd/main.go`.

Пример для Gateway:

```bash
cd gateway
go run cmd/main.go
```

---

## Миграции базы данных

SQL-файлы для миграций находятся в папке:

```
gateway/migrations/
```

Включают создание таблиц пользователей, чатов, участников чатов и сообщений.

---

## Документация API

Во всех сервисах есть папка `/docs` со Swagger описаниями:

- `swagger.yaml` — основное описание API.
- `swagger.json` — для генерации клиентов и UI.

Swagger можно открыть через любой редактор, например: [Swagger Editor](https://editor.swagger.io/).

---

## Назначение сервисов подробнее

### Gateway

- WebSocket сервер.
- Kafka продюсер и консьюмер.
- Redis хранение активных сессий WebSocket по пользователям.
- Передача HTTP-запросов в Auth, User, Chat.

### Auth

- Регистрация и авторизация пользователей.
- Хеширование паролей.
- Генерация и проверка JWT токенов.

### Chat

- Создание чатов.
- Управление участниками чатов.
- Список доступных чатов для пользователя.

### User

- Регистрация и обновление профилей пользователей.

### Message

- Сохраняет сообщения в базу данных.
- Формирует события доставки в Kafka.

---

## Дополнительные замечания

- Redis используется для сопоставления WebSocket соединений и пользователей.
- Kafka обеспечивает отказоустойчивую доставку и асинхронность обработки сообщений.
- PostgreSQL хранит основную бизнес-логику: пользователи, чаты, сообщения.

---

## Комментарий для портфолио

- Это мой второй крупный проект, реализованный в 17 лет.
- Основной упор сделан на микросервисную архитектуру и работу с асинхронной обработкой данных.
- Код сопровождается документацией Swagger.
- Реализованы: безопасность через JWT, масштабируемая доставка сообщений, разделение логики между сервисами.

---

## Контакты

Код каждого сервиса подробно документирован. При возникновении вопросов — все можно понять из структуры кода.

---

---

## Развёртывание проекта

### 1. Сборка Docker-образов сервисов

Перед запуском docker-compose необходимо собрать образы всех микросервисов. Перейдите в директории каждого сервиса и соберите образы:

```bash
# Сборка Gateway
cd gateway
docker build -t gateway .

# Сборка Auth
cd ../auth
docker build -t auth-service .

# Сборка User
cd ../user
docker build -t user-service .

# Сборка Chat
cd ../chat
docker build -t chat-service .

# Сборка Message
cd ../message
docker build -t message-service .
```

### 2. Запуск всей системы через docker-compose

После сборки образов переходим в папку `gateway`, где находится docker-compose файл, и запускаем все сервисы:

```bash
cd gateway
docker-compose up --build
```

Docker Compose поднимет все микросервисы, базы данных, Kafka, Redis и настроит сетевое взаимодействие между ними.

### 3. Зависимости, которые автоматически запускаются:

- **PostgreSQL** — база данных (user: `user`, password: `secret`, db: `postgres`)
- **Redis** — хранение WebSocket-сессий.
- **Zookeeper + Kafka** — брокер сообщений.

### 4. Переменные окружения

Большая часть переменных окружения уже прописана внутри docker-compose, но при желании вы можете переопределить их через свои `.env` файлы.

Пример параметров PostgreSQL:

```env
POSTGRES_USER=user
POSTGRES_PASSWORD=secret
POSTGRES_DB=postgres
POSTGRES_HOST=postgres
POSTGRES_PORT=5432
```

Kafka:

```env
KAFKA_HOST=kafka
KAFKA_PORT=9092
```

Redis:

```env
REDIS_HOST=redis
REDIS_PORT=6379
```

---

## Быстрый старт для теста локально (без Docker)

Если хотите запустить сервисы в режиме разработки:

1. Установите Kafka, Redis, PostgreSQL локально.
2. Запустите сервисы из папок командой:

```bash
go run cmd/main.go
```

3. Обязательно настройте `.env` файлы для каждого сервиса локально.

---